<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StoreGo - Stripe Test Page</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .StripeElement {
        box-sizing: border-box;
        height: 40px;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        background-color: white;
      }
      .StripeElement--focus {
        border-color: #4f46e5;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      }
      .StripeElement--invalid {
        border-color: #ef4444;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex min-h-screen items-center justify-center">
      <div class="w-full max-w-md rounded-lg bg-white p-8 shadow-md">
        <div class="mb-8 text-center">
          <h2 class="text-2xl font-bold text-gray-900">Stripe Test Payment</h2>
          <p class="mt-1 text-gray-600">
            Test your StoreGo payment integration
          </p>
        </div>

        <!-- Test mode banner -->
        <div class="mb-6 border-l-4 border-yellow-400 bg-yellow-50 p-4">
          <div class="flex">
            <div class="ml-3">
              <p class="text-sm text-yellow-700">
                <strong>Test Mode</strong> - Using test Stripe keys. No real
                charges will be made.
              </p>
              <p class="mt-1 text-xs text-yellow-600">
                Test Card: 4242 4242 4242 4242 | Exp: Any future date | CVC: Any
                3 digits
              </p>
            </div>
          </div>
        </div>

        <!-- Payment Form -->
        <form id="payment-form" class="space-y-4">
          <div class="form-group">
            <label for="amount" class="block text-sm font-medium text-gray-700"
              >Amount ($)</label
            >
            <input
              type="number"
              id="amount"
              value="10.00"
              step="0.01"
              min="1"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500"
            />
          </div>

          <div class="form-group">
            <label
              for="card-element"
              class="mb-1 block text-sm font-medium text-gray-700"
              >Credit or Debit Card</label
            >
            <div id="card-element" class="bg-white">
              <!-- Stripe Elements will be inserted here -->
            </div>
            <div
              id="card-errors"
              role="alert"
              class="mt-1 h-5 text-sm text-red-500"
            ></div>
          </div>

          <button
            type="submit"
            id="submit-button"
            class="w-full rounded-md bg-indigo-600 px-4 py-2 text-white transition-colors hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          >
            Pay $10.00
          </button>
        </form>

        <!-- Result Panel -->
        <div id="result-panel" class="mt-6 hidden rounded-md bg-gray-50 p-4">
          <h3 class="font-medium text-gray-900">Payment Result</h3>
          <pre
            id="result-json"
            class="mt-2 max-h-40 overflow-auto rounded bg-gray-100 p-2 text-xs"
          ></pre>
        </div>

        <!-- Test Actions -->
        <div class="mt-8 border-t border-gray-200 pt-4">
          <h3 class="text-sm font-medium text-gray-900">
            Test Different Scenarios
          </h3>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <button
              type="button"
              class="test-card rounded bg-gray-100 px-2 py-1 text-xs hover:bg-gray-200"
              data-card="4242424242424242"
            >
              ‚úì Successful payment
            </button>
            <button
              type="button"
              class="test-card rounded bg-gray-100 px-2 py-1 text-xs hover:bg-gray-200"
              data-card="4000002760003184"
            >
              üîí 3D Secure auth
            </button>
            <button
              type="button"
              class="test-card rounded bg-gray-100 px-2 py-1 text-xs hover:bg-gray-200"
              data-card="4000000000009995"
            >
              ‚ùå Declined payment
            </button>
            <button
              type="button"
              class="test-card rounded bg-gray-100 px-2 py-1 text-xs hover:bg-gray-200"
              data-card="4000000000009987"
            >
              ‚ö†Ô∏è Lost card
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Stripe - Use your publishable key
        // This should be replaced with your actual publishable key from .env
        const stripe = Stripe(
          "pk_test_51RQlVxC7OEnDMw98A3apz82xFBX9GLnUE3mIlAMtBKy1Ndj5KDeBA53drRmQ7BMdJVeou3PLjMFSU6a8fWSWHYEO007CafhnRk",
        );
        const elements = stripe.elements();

        // Create a card Element and mount it
        const cardElement = elements.create("card");
        cardElement.mount("#card-element");

        // Handle real-time validation errors from the card Element
        cardElement.on("change", function (event) {
          const displayError = document.getElementById("card-errors");
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = "";
          }
        });

        // Update button text with amount
        const amountInput = document.getElementById("amount");
        const submitButton = document.getElementById("submit-button");

        amountInput.addEventListener("change", function () {
          submitButton.textContent = `Pay $${parseFloat(amountInput.value).toFixed(2)}`;
        });

        // Test card buttons
        const testCardButtons = document.querySelectorAll(".test-card");
        testCardButtons.forEach((button) => {
          button.addEventListener("click", function () {
            cardElement.destroy();
            const newCardElement = elements.create("card", {
              value: {
                cardNumber: this.dataset.card,
                cardExpMonth: "12",
                cardExpYear: "2030",
                cardCvc: "123",
              },
            });
            newCardElement.mount("#card-element");
          });
        });

        // Handle form submission
        const form = document.getElementById("payment-form");
        form.addEventListener("submit", async function (event) {
          event.preventDefault();

          // Disable the submit button to prevent repeated clicks
          submitButton.disabled = true;
          submitButton.textContent = "Processing...";          try {
            // Create a PaymentMethod
            const result = await stripe.createPaymentMethod({
              type: "card",
              card: cardElement,
            });

            if (result.error) {
              showError(result.error.message);
              return;
            }

            // Convert amount to cents
            const amountInCents = Math.round(
              parseFloat(amountInput.value) * 100,
            );

            // Prepare the payment data
            const paymentData = {
              paymentMethodId: result.paymentMethod.id,
              amount: amountInCents,
              currency: "usd",
              description: "StoreGo test payment",
            };

            // Show the data being sent
            showResult({
              title: "Sending to server...",
              paymentData,
            });

            // Call our test payment API
            const response = await fetch('/api/test-payment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(paymentData),
            });

            const responseData = await response.json();

            if (!response.ok) {
              throw new Error(responseData.message || 'Payment processing failed');
            }

            // Check if additional action is needed (like 3D Secure)
            if (responseData.requiresAction && responseData.clientSecret) {
              showResult({
                title: "Additional authentication required...",
                status: responseData.status,
                paymentIntentId: responseData.paymentIntentId,
              });

              // Use Stripe.js to handle the additional action
              const { error, paymentIntent } = await stripe.handleCardAction(
                responseData.clientSecret
              );

              if (error) {
                throw new Error(error.message);
              } else if (paymentIntent.status === "succeeded") {
                // Payment completed successfully after authentication
                showResult({
                  title: "Payment completed successfully!",
                  success: true,
                  paymentIntent,
                });

                submitButton.textContent = "Success!";
                submitButton.classList.remove("bg-indigo-600", "hover:bg-indigo-700");
                submitButton.classList.add("bg-green-600", "hover:bg-green-700");
                return;
              }
            } else if (responseData.status === "succeeded") {
              // Payment completed successfully
              showResult({
                title: "Payment completed successfully!",
                success: true,
                status: responseData.status,
                paymentIntentId: responseData.paymentIntentId,
              });

              submitButton.textContent = "Success!";
              submitButton.classList.remove("bg-indigo-600", "hover:bg-indigo-700");
              submitButton.classList.add("bg-green-600", "hover:bg-green-700");
            }
          } catch (error) {
            showError("An unexpected error occurred. Please try again.");
            console.error("Payment error:", error);
          } finally {
            setTimeout(() => {
              submitButton.disabled = false;
              submitButton.textContent = `Pay $${parseFloat(amountInput.value).toFixed(2)}`;
              submitButton.classList.remove(
                "bg-green-600",
                "hover:bg-green-700",
              );
              submitButton.classList.add(
                "bg-indigo-600",
                "hover:bg-indigo-700",
              );
            }, 3000);
          }
        });

        function showError(errorMessage) {
          const errorElement = document.getElementById("card-errors");
          errorElement.textContent = errorMessage;
          submitButton.textContent = "Try again";
          submitButton.disabled = false;
        }        function showResult(data) {
          const resultPanel = document.getElementById("result-panel");
          const resultJson = document.getElementById("result-json");
          const resultTitle = resultPanel.querySelector("h3");

          if (data.title) {
            resultTitle.textContent = data.title;
          } else {
            resultTitle.textContent = "Payment Result";
          }

          resultPanel.classList.remove("hidden");
          resultJson.textContent = JSON.stringify(data, null, 2);
        }
      });
    </script>
  </body>
</html>
