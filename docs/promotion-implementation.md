# Promotion System Implementation Guide

## Overview

This document outlines the implementation strategy for integrating promotions into the mobile app generated by Store-Go. The system allows users to:

1. View promotions on product detail screens
2. Navigate to dedicated promotion detail pages
3. Receive notifications when adding products with active promotions
4. Track progress toward promotion requirements
5. Apply promotions at checkout

## Database Schema

The promotion system is built around the `AppPromotion` table with the following structure:

```typescript
export const AppPromotion = pgTable("app_promotion", {
  id: uuid("id").primaryKey().defaultRandom(),
  storeId: uuid("store_id")
    .notNull()
    .references(() => stores.id),
  userId: text("user_id")
    .notNull()
    .references(() => user.id),
  name: varchar("name", { length: 255 }).notNull(),
  description: text("description"),
  discountType: discountTypeEnum("discount_type").notNull(), // percentage, fixed_amount, free_shipping, buy_x_get_y
  discountValue: decimal("discount_value", { precision: 10, scale: 2 }), // Amount or percentage off
  couponCode: varchar("coupon_code", { length: 50 }), // Optional coupon code
  minimumPurchase: decimal("minimum_purchase", {
    precision: 10,
    scale: 2,
  }).default("0"), // Minimum order value
  buyQuantity: integer("buy_quantity"), // for by_x_get_y option
  getQuantity: integer("get_quantity"), // for by_x_get_y option
  yApplicableProducts: json("y_applicable_products").default([]), // Products that can be "Y" items
  yApplicableCategories: json("y_applicable_categories").default([]), // Categories that can be "Y" items
  sameProductOnly: boolean("same_product_only").default(true), // If true, Y must be same as X
  promotionImage: varchar("promotion_image", { length: 500 }),
  usageCount: integer("usage_count").default(0), // Track how many times it's been used
  startDate: timestamp("start_date").notNull(),
  endDate: timestamp("end_date").notNull(),
  isActive: boolean("is_active").default(true).notNull(),
  applicableProducts: json("applicable_products").default([]), // Array of product IDs
  applicableCategories: json("applicable_categories").default([]), // Array of category IDs
  created_at: timestamp("created_at").defaultNow().notNull(),
  updated_at: timestamp("updated_at").defaultNow().notNull(),
});
```

## Required API Endpoints

### 1. Get Promotions for a Product

**Endpoint:** `GET /api/mobile-app/products/{productId}/promotions`

**Purpose:** Retrieve all active promotions applicable to a specific product.

**Implementation:**

- Extend `PromotionRepository` to include a `findByProductId` method
- Filter promotions by:
  - Active status
  - Current date falls between start and end dates
  - Product ID is in `applicableProducts` OR
  - Product's category ID is in `applicableCategories`

```typescript
static async findByProductId(productId: string, storeId: string) {
  try {
    const product = await db.query.AppProduct.findFirst({
      where: eq(AppProduct.id, productId),
      columns: {
        id: true,
        categoryId: true,
      },
    });

    if (!product) return [];

    const now = new Date();

    return await db.query.AppPromotion.findMany({
      where: and(
        eq(AppPromotion.storeId, storeId),
        eq(AppPromotion.isActive, true),
        lte(AppPromotion.startDate, now),
        gte(AppPromotion.endDate, now),
        or(
          sql`${productId} = ANY(${AppPromotion.applicableProducts})`,
          sql`${product.categoryId} = ANY(${AppPromotion.applicableCategories})`
        )
      ),
    });
  } catch (error) {
    console.error(`Error fetching promotions for product ${productId}:`, error);
    throw new Error(`Failed to fetch promotions for product ${productId}`);
  }
}
```

### 2. Get Promotion Details

**Endpoint:** `GET /api/mobile-app/promotions/{promotionId}`

**Purpose:** Fetch complete details about a specific promotion.

**Implementation:**

- Use the existing `findById` method in `PromotionRepository`
- Extend it to include related products if needed

### 3. Check Cart for Promotions

**Endpoint:** `POST /api/mobile-app/cart/check-promotions`

**Purpose:** Analyze cart contents to identify applicable promotions and how close the user is to qualifying.

**Implementation:**

- Create a new method in `PromotionRepository` called `checkCartForPromotions`
- Accept cart items as input
- For each promotion type, implement eligibility checking logic
- Return eligible promotions and progress (e.g., "Add $10 more for free shipping")

```typescript
interface CartItem {
  productId: string;
  quantity: number;
  price: number;
}

interface PromotionProgress {
  promotionId: string;
  name: string;
  isEligible: boolean;
  progressMessage?: string;
  discountAmount?: number;
}

static async checkCartForPromotions(cartItems: CartItem[], storeId: string): Promise<PromotionProgress[]> {
  // Implementation depends on promotion types
}
```

### 4. Apply Promotion to Order

**Endpoint:** `POST /api/mobile-app/checkout/apply-promotion`

**Purpose:** Apply an eligible promotion during checkout.

**Implementation:**

- Create a method to validate and apply the promotion
- Calculate discount amount based on promotion type
- Return updated order total

## Implementation Steps

### 1. Server-Side Implementation

1. **Enhance PromotionRepository:**

   - Add `findByProductId` method
   - Add `checkCartForPromotions` method
   - Add `applyPromotion` method

2. **Create PromotionController endpoints:**

   - `getPromotionsForProduct`
   - `getPromotionDetails` (or extend existing endpoint)
   - `checkCartPromotions`
   - `applyPromotion`

3. **Implement Promotion Eligibility Logic:**

   - Create utility class/functions for each discount type:
     - `checkPercentageDiscount`
     - `checkFixedAmountDiscount`
     - `checkFreeShipping`
     - `checkBuyXGetY`

4. **Add Pusher Notification Integration:**
   - Extend existing notification system for promotion events
   - Create notification types for promotion eligibility

### 2. Mobile App Implementation

1. **Product Details Screen:**

   - Call API to get product promotions
   - Display promotion badge if applicable
   - Add click handler to view promotion details

2. **Promotion Details Screen:**

   - Display complete promotion details
   - Show eligibility requirements
   - Include "Add to Cart" button

3. **Cart Screen:**

   - Check for applicable promotions
   - Display promotion progress
   - Show notification when user becomes eligible

4. **Checkout Flow:**
   - Apply eligible promotions
   - Display discount in order summary

## Testing Scenarios

1. **Product-Specific Promotions:**

   - Add a product with an active promotion to cart
   - Verify promotion appears and applies correctly

2. **Category-Wide Promotions:**

   - Add a product from a category with promotion
   - Verify category promotion applies

3. **Minimum Purchase Promotions:**

   - Add items below threshold
   - Verify progress message appears
   - Add more items to reach threshold
   - Verify promotion applies

4. **Buy X Get Y Scenarios:**

   - Add X quantity of applicable product
   - Verify Y items discounted/free
   - Test with same product and different product scenarios

5. **Coupon Code Promotions:**
   - Verify that coupon code field appears when needed
   - Test valid and invalid coupon scenarios

## Notification System

Implement notification triggers for:

1. **Eligibility Notifications:**

   - When a product with promotion is added to cart

2. **Progress Notifications:**

   - When user gets closer to meeting promotion requirements
   - "Add one more item to get 20% off!"

3. **Success Notifications:**
   - When promotion is successfully applied
   - "You saved $15 with this promotion!"

## Error Handling

Implement error handling for:

1. **Expired Promotions:**

   - Handle cases where promotion expires between viewing and checkout

2. **Changed Conditions:**

   - Handle cases where promotion conditions change while in user's cart

3. **Invalid Combinations:**
   - Handle cases where user tries to apply multiple incompatible promotions

## Performance Considerations

1. **Query Optimization:**

   - Index product and category IDs for faster lookups
   - Consider materialized views for common promotion queries

2. **Caching Strategy:**

   - Cache active promotions for frequent product views
   - Invalidate cache when promotions change

3. **Batch Processing:**
   - Process multiple cart items against promotions efficiently

## Future Enhancements

Consider future enhancements:

1. **Personalized Promotions:**

   - Promotions based on user purchase history

2. **Time-Limited Flash Sales:**

   - Countdown timers for expiring promotions

3. **Referral Promotions:**

   - Discounts for referring friends

4. **Loyalty Tiers:**
   - Special promotions for regular customers

## API Reference

### Get Promotions for Product

```
GET /api/mobile-app/products/{productId}/promotions

Response:
{
  "status": "success",
  "data": [
    {
      "id": "uuid",
      "name": "Summer Sale",
      "description": "Get 20% off all summer items",
      "discountType": "percentage",
      "discountValue": "20.00",
      "promotionImage": "url/to/image.jpg"
    }
  ]
}
```

### Get Promotion Details

```
GET /api/mobile-app/promotions/{promotionId}

Response:
{
  "status": "success",
  "data": {
    "id": "uuid",
    "name": "Summer Sale",
    "description": "Get 20% off all summer items",
    "discountType": "percentage",
    "discountValue": "20.00",
    // Full promotion details
  }
}
```

### Check Cart Promotions

```
POST /api/mobile-app/cart/check-promotions
Body: {
  "items": [
    {
      "productId": "uuid",
      "quantity": 2,
      "price": 29.99
    }
  ]
}

Response:
{
  "status": "success",
  "data": {
    "eligiblePromotions": [
      {
        "id": "uuid",
        "name": "Summer Sale",
        "isEligible": true,
        "discountAmount": 12.00
      }
    ],
    "progressPromotions": [
      {
        "id": "uuid",
        "name": "Free Shipping",
        "isEligible": false,
        "progressMessage": "Add $20.01 more to get free shipping"
      }
    ]
  }
}
```

### Apply Promotion

```
POST /api/mobile-app/checkout/apply-promotion
Body: {
  "promotionId": "uuid",
  "items": [
    {
      "productId": "uuid",
      "quantity": 2,
      "price": 29.99
    }
  ],
  "couponCode": "SUMMER25" // Optional
}

Response:
{
  "status": "success",
  "data": {
    "subtotal": 59.98,
    "discount": 12.00,
    "shipping": 5.99,
    "total": 53.97,
    "appliedPromotion": {
      "id": "uuid",
      "name": "Summer Sale"
    }
  }
}
```
